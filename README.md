# 轨道校正强化学习项目 (v1.1)

本项目使用TD3（Twin Delayed Deep Deterministic Policy Gradient）强化学习算法来校正粒子加速器中的电子束轨道。通过强化学习智能体控制水平和垂直校正器的角度，使电子束轨道尽可能接近理想轨道。

## 新增功能 (v1.1)

- **贝叶斯超参数优化**：集成Optuna库实现强化学习超参数的自动优化，包括奖励权重、学习率、噪声参数等
- **并行优化支持**：支持多线程并行执行超参数优化，提高优化效率
- **动态评估策略**：根据优化进度自动调整训练回合数，前期快速筛选，后期精细评估
- **早期停止机制**：在训练过程中实现性能监控，避免无效训练

## 项目结构

- `fodo_lattice.py`: 定义FOFO晶格结构，包括磁铁、漂移段、监测器和校正器等组件
- `td3_agent.py`: 实现TD3强化学习算法，包括环境、智能体和训练过程
- `BayesianOptimize.py`: 实现基于Optuna的贝叶斯超参数优化功能
- `main.ipynb`: Jupyter笔记本文件，用于运行训练和测试过程，包含可视化结果

## 工作原理

该项目通过强化学习算法控制粒子加速器中的束流轨道。环境中，智能体观察当前的轨道偏差状态，并决定如何调整水平和垂直校正器的角度来减小偏差。奖励函数设计鼓励减小轨道偏差，同时惩罚过大的校正动作。

贝叶斯优化通过构建概率模型来智能地搜索最优超参数组合，相比于网格搜索和随机搜索，能够更高效地找到接近最优的参数配置。

## 依赖库及版本

- Python 3.10
- OCELOT 24.03.0
- PyTorch 1.12.1
- NumPy 1.21.5
- Gym 0.21.0
- Optuna 3.1.0 或更高版本

## 安装说明

1. 确保已安装Python 3.10
2. 安装OCELOT:
   ```
   conda install -c ocelot-collab ocelot
   ```
   ```
   git clone https://github.com/ocelot-collab/ocelot.git
   ```
   ```python
   python setup.py install
   ```
3. 安装其他依赖:
   ```
   pip install torch==1.12.1 numpy==1.21.5 gym==0.21.0 optuna>=3.1.0
   ```

## 使用方法

### 基础训练
1. 运行训练:
   打开`main.ipynb`并在Jupyter Notebook中执行所有单元格来训练智能体。

2. 查看结果:
   训练过程中的奖励、轨道误差等指标将在Notebook中显示。

### 超参数优化
1. 运行贝叶斯优化:
   在`BayesianOptimize.py`中配置优化参数，然后运行该脚本开始超参数优化。

2. 配置优化选项:
   - `n_calls`: 优化迭代次数
   - `random_state`: 随机种子，确保结果可重现
   - `fast_eval`: 是否使用快速评估模式
   - `n_jobs`: 并行任务数，设置为大于1的值可启用并行优化

3. 查看优化结果:
   优化完成后，将显示最佳超参数组合和对应的性能指标。

## 功能特性

### 动态奖励权重调整
在训练过程中，系统会根据训练进度和智能体性能动态调整奖励函数中各部分的权重，以平衡不同目标。

### 校正器动态权重
根据当前轨道误差分布动态调整不同校正器的控制权重，使误差较大的区域对应的校正器获得更高的权重。

### 数据归一化
对BPM读数进行动态归一化处理，基于实际观测数据的统计特性进行标准化，提高训练稳定性。

### 多维度奖励函数
奖励函数综合考虑轨道改善、动作幅度、稳定性和完成情况等多个维度，引导智能体学习高质量的控制策略。

## 当前问题和后续改进方向

### 当前存在的问题

1. **训练效果不佳**：智能体在训练过程中难以有效将轨道调整到预期结果，即使经过长时间训练也没有明显改善。

2. **收敛速度慢**：当前算法需要大量训练回合才能看到明显效果，训练效率有待提高。

3. **多进程训练受限**：由于OCELOT框架本身不支持多进程，限制了并行训练的效率提升。

### 后续改进方向

1. **晶格设计优化**：
   - 在晶格出口处增加BPM监测器，提供更完整的轨道信息
   - 优化磁铁和校正器布局，提高校正效率

2. **算法和模型改进**：
   - 重新设计奖励函数，提供更密集和有效的奖励信号
   - 调整神经网络结构，可能采用注意力机制处理BPM间关系
   - 动态调整网络超参数以适应不同训练阶段

3. **计算性能优化**：
   - 重写轨道生成模块，使用矩阵运算替代OCELOT调用
   - 实现响应矩阵方法，提高计算效率
   - 支持GPU加速计算，充分利用硬件资源

4. **训练策略优化**：
   - 优化贝叶斯超参数搜索空间和策略
   - 实现课程学习，从简单任务逐步过渡到复杂任务
   - 增加探索策略，避免陷入局部最优

5. **并行化和分布式训练**：
   - 解决OCELOT框架的多进程限制问题
   - 实现真正的并行训练以大幅提升训练速度
   - 考虑使用分布式训练框架进一步提高效率
